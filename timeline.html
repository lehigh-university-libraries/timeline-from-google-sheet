<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Timeline from Google Sheets</title>
<style>
  :root{
    --bg: #f5f0e6;
    --fg: #1f2226;
    --hero-h: min(40vh, 480px);
    --maxw: 1200px;
    --card: #ffffff;
    --shadow-lg: 0 18px 40px rgba(0,0,0,0.16);
    --line: #111;
    --label-bg: #6e5222;   /* gold/brown */
    --label-fg: #fff9ec;
  }
  * { box-sizing: border-box; }
  body { margin:0; background: var(--bg); color: var(--fg); font:20px/1.6 ui-sans-serif,system-ui; }
  body.modal-open { overflow:hidden; }

  .skip-link {
    position: absolute;
    left: -999px;
    top: auto;
    width: 1px;
    height: 1px;
    overflow: hidden;
  }
  .skip-link:focus {
    left: 8px;
    top: 8px;
    width: auto;
    height: auto;
    padding: 8px 12px;
    background: #000;
    color: #fff;
    z-index: 10000;
  }

  /* HERO */
  .hero { position: relative; width:100%; height:var(--hero-h); background:#ddd center/cover no-repeat; background-position: center 30%; display:grid; place-items:end start; border-bottom: 2px solid #000; }
  .hero::before { content:""; position:absolute; inset:0; background:linear-gradient(180deg,rgba(0,0,0,0.08) 0%,rgba(0,0,0,0.40) 55%,rgba(0,0,0,0.60) 100%); }
  .hero-inner { position:relative; width:100%; max-width:var(--maxw); padding:clamp(14px,3vw,28px); }
  .title { margin:0; padding:0; font-weight:800; font-size:clamp(36px,7.5vw,75px); line-height:1.05; color:#fff; text-shadow:0 2px 18px rgba(0,0,0,0.35);}
  .subtitle { margin:2px 0 0 0; padding:0; font-size:clamp(22px,4vw,38px); line-height:1.15; color: #fff; text-shadow:0 2px 14px rgba(0,0,0,0.3); }

  /* LEFT MENU */
  .hamburger {
    position: fixed; left: 0; top: 50%; transform: translateY(-50%);
    z-index: 1000; width: 27px; height: 46px;
    border-radius: 0 14px 14px 0;
    border: 1px solid rgba(0,0,0,0.35); border-left: none;
    background: var(--label-bg);
    box-shadow: var(--shadow-lg);
    display: flex; flex-direction: column; justify-content: center; align-items: flex-start;
    padding-left: 2px; line-height: 0; cursor: pointer;
  }
  .hamburger .bar { display:block; width:19px; height:2px; background:#fff; border-radius:1px; margin:4px 0; }

  .menu-panel {
    position: fixed; left: 41px; top: 50%;
    transform: translate(-8px, -50%) scale(0.98);
    opacity: 0; pointer-events: none;
    transition: opacity 160ms ease, transform 160ms ease;
    z-index: 1100; background: var(--card);
    border: 1px solid #000; border-radius: 18px;
    box-shadow: var(--shadow-lg); padding: 10px;
    width: min(90vw, 420px);
  }
  .menu-panel.open { opacity:1; pointer-events:auto; transform: translate(0, -50%) scale(1); }

  .menu-list { display:grid; gap:0; margin:0; padding:8px; border-radius:14px; background:#faf8f2; list-style:none; }
  .menu-link { display:block; text-decoration:none; color:var(--fg); padding:0px 12px; border-radius:12px; white-space:nowrap; font-size:16px; line-height:1.15; }
  .menu-link:hover { background:#f3efe6; }
  .menu-link.current { background:#ece8df; font-weight:600; }
  .menu-link.branch::before { content: "├─ "; }
  .menu-link.branch-last::before { content: "╰─ "; }

  /* CONTENT */
  .sections { max-width:var(--maxw); margin:32px auto; padding:0 24px; }
  .section { position:relative; margin-bottom:80px; }
  .section-heading { text-align:center; font-size:clamp(28px,5.5vw,46px); font-weight:750; margin:64px 0 8px; scroll-margin-top:0; }

  .section-block { position:relative; z-index:1; background:none; border:2px solid #000; border-radius:6px; padding:0; display:flex; flex-direction:column; gap:0; overflow:hidden; }
  .section-image { max-width:100%; height:auto; display:block; border:none; border-bottom:2px solid #000; border-radius:6px 6px 0 0; align-self:stretch; cursor:zoom-in; }
  .section-caption { min-height:25px; background:#ddd; padding:4px 15px 25px 15px; text-align:right; font-size:14px; font-style:italic; }
  .section-description { min-height:25px; background:#ddd; padding:4px 15px 15px 25px; text-align:left; font-size:20px; }
  .section-caption a, .section-description a { color: inherit; text-decoration: underline; word-break: break-word; }

  /* TIMELINE */
  .timeline { position: relative; z-index: 0; margin: 0 auto; padding: 0 0 64px; }
  .timeline-line { position:absolute; left:50%; top:0; bottom:0; width:4px; background:var(--line); transform:translateX(-50%); z-index:0; }
  .timeline-line::after{
    content:""; position:absolute; left:50%; transform:translateX(-50%); bottom:8px;
    border-style:solid; border-width:10px 8px 0 8px; border-color: var(--line) transparent transparent transparent;
    filter: drop-shadow(0 2px 2px rgba(0,0,0,0.15));
  }

  .timeline-entry { position:absolute; width:min(520px,42%); scroll-margin-top:0; }
  .timeline-entry.left  { left: 0; padding-right: 28px; }
  .timeline-entry.right { right:0; padding-left: 28px; }

  .timeline-label{
    position:absolute; left:50%; transform: translate(-50%, -50%);
    background: var(--label-bg); color: var(--label-fg);
    font-size: 14px; line-height: 1; padding: 6px 12px;
    border-radius: 8px; box-shadow: 0 6px 16px rgba(0,0,0,0.25);
    white-space: nowrap; z-index: 2; pointer-events: none;
  }
  .timeline-label.left{  padding-left:20px;  clip-path: polygon(14px 0,100% 0,100% 100%,14px 100%,0 50%); }
  .timeline-label.right{ padding-right:20px; clip-path: polygon(0 0,calc(100% - 14px) 0,100% 50%,calc(100% - 14px) 100%,0 100%); }

  .entry-card { background:none; border:2px solid #000; border-radius:6px; overflow:hidden; }
  .entry-image { display:block; width:100%; height:auto; border-bottom:2px solid #000; cursor:zoom-in; }
  .entry-caption { min-height:25px; background:#ddd; padding:4px 15px 25px 15px; text-align:right; font-size:14px; font-style:italic; }
  .entry-description { min-height:25px; background:#ddd; padding:4px 15px 15px 25px; font-size:20px; }
  .entry-caption a, .entry-description a { color:inherit; text-decoration:underline; }

  /* FALLBACK */
  .fallback { max-width:var(--maxw); margin:24px auto; padding:12px 24px; color:#814; background:#fff7f0; border:1px solid #f2d6c8; border-radius:10px; display:none; }
  .fallback.visible { display:block; }
  .fallback code { background:#ffe; padding:2px 6px; border-radius:6px; }

  /* LIGHTBOX */
  .lightbox { position: fixed; inset: 0; background: rgba(0,0,0,0.92); display: none; align-items: center; justify-content: center; z-index: 3000; }
  .lightbox.open { display:flex; }
  .lightbox-img { max-width: 92vw; max-height: 92vh; display:block; border-radius: 8px; box-shadow: 0 30px 120px rgba(0,0,0,0.6); }
  .lightbox-close { position: absolute; top: 14px; left: 14px; width:52px; height:52px; border:none; border-radius:0; background:none; color:#fff; cursor:pointer; display:flex; align-items:center; justify-content:center; font-size:42px; line-height:1; padding:0; outline:none; box-shadow:none; -webkit-appearance:none; -moz-appearance:none; -webkit-tap-highlight-color:transparent; }
  .lightbox-close:hover { background:none; color:#ccc; }
  .lightbox-hit { position:absolute; inset:0; }

  /* FOOTER */
  footer {
    display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center;
    padding: 40px 20px 50px; background-color: #222; position: relative;
    font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
    color: #fff; border-top: 3px solid #f5e7d4; width: 100%;
  }
  .footer-headline {
    color: #f5e7d4; font-size: 2rem; font-weight: bold; letter-spacing: 0.8px;
    margin-bottom: 24px; text-shadow: 2px 2px 4px #000; font-style: italic;
  }
  .footer-links { font-size: 1rem; margin: 4px 0; }
  .footer-links:first-of-type { margin-top: 0; }
  .footer-links:last-of-type  { margin-bottom: 0; }
  .footer-links a { margin: 0 12px; text-decoration: none; color: #fff; }
  .footer-links a:hover { text-decoration: underline; }
  .footer-links .divider { color: #fff; margin: 0 6px; }
  .footer-sheet-link { font-size: 0.85rem; position: absolute; right: 20px; bottom: 10px; }
  .footer-sheet-link a { color: #fff; text-decoration: none; }
  .footer-sheet-link a:hover { text-decoration: underline; }
</style>
</head>
<body>

<a href="#sections" class="skip-link">Skip to main content</a>
<a id="top"></a>
<section id="hero" class="hero">
  <div class="hero-inner">
    <h1 id="title" class="title">Loading…</h1>
    <h2 id="subtitle" class="subtitle"></h2>
  </div>
</section>

<!-- Left hamburger -->
<button id="hamburger" class="hamburger" type="button" aria-label="Open menu" aria-expanded="false" aria-controls="menu">
  <span class="bar" aria-hidden="true"></span><span class="bar" aria-hidden="true"></span><span class="bar" aria-hidden="true"></span>
</button>
<nav id="menu" class="menu-panel" aria-label="Section navigation" aria-hidden="true">
  <ul id="menuList" class="menu-list"></ul>
</nav>

<!-- Fallback -->
<div id="fallback" class="fallback">
  <strong>Couldn’t fetch the Google CSV for the selected tab.</strong>
  <div style="margin-top:8px">
    <div>Quick options:</div>
    <ol style="margin:6px 0 10px 18px">
      <li>Open this page via a local server (<code>python3 -m http.server</code>)</li>
      <li>Ensure the <b>Export</b> tab is shared: <em>Anyone with the link → Viewer</em></li>
      <li>Or load a CSV file now: <input id="fileInput" type="file" accept=".csv" /></li>
    </ol>
  </div>
  <div id="fallbackNote" style="font-size:14px;color:#555"></div>
</div>

<main id="sections" class="sections"></main>

<!-- Lightbox -->
<div id="lightbox" class="lightbox" role="dialog" aria-modal="true" aria-label="Image viewer">
  <div class="lightbox-hit" data-close></div>
  <img id="lightboxImg" class="lightbox-img" alt="" />
  <button id="lightboxClose" class="lightbox-close" aria-label="Close (Esc)" data-close>&times;</button>
</div>

<!-- Footer -->
<footer>
  <div class="footer-headline">
    Informationland: The Past and Future of Libraries
  </div>

  <div class="footer-links">
    <a href="https://exhibits.lib.lehigh.edu/exhibits/show/informationland">Exhibit Home</a><span class="divider">|</span>
    <a href="https://exhibits.lib.lehigh.edu/visualizations/timelines/library-building-milestones">Lehigh Library Building Milestones</a><span class="divider">|</span>
    <a href="https://exhibits.lib.lehigh.edu/visualizations/timelines/linderman-timeline">Linderman Library Timeline</a><span class="divider">|</span>
    <a href="https://uploads.knightlab.com/storymapjs/d90b8e3a505293b168e7ba722000de1b/aliceinfoland-fairchild-martindale-library/index.html">Fairchild-Martindale Library Storymap</a>
  </div>

  <div class="footer-links">
    <a href="https://lts.lehigh.edu/find/special-collections">Libraries Special Collections</a><span class="divider">|</span>
    <a href="https://lts.lehigh.edu/about/about-lehigh-libraries">Lehigh University Libraries</a><span class="divider">|</span>
    <a href="https://lts.lehigh.edu/">Library Technology Services</a>
  </div>

  <div class="footer-sheet-link">
    <a id="editorLink" href="#" target="_blank" rel="noopener">Editor Login</a>
  </div>
</footer>

<script>
/* ===== Config: load timeline.conf (key=value) ===== */
async function loadConfig(){
  try{
    const res = await fetch('timeline.conf', {cache:'no-cache'});
    if(!res.ok) throw new Error('timeline.conf not found');
    const txt = await res.text();
    const cfg = {};
    for(const raw of txt.split(/\r?\n/)){
      const line = raw.trim();
      if(!line || line.startsWith('#')) continue;
      const m = line.match(/^([A-Za-z0-9_]+)\s*=\s*(.+)$/);
      if(m){ cfg[m[1]] = m[2]; }
    }
    if(!cfg.VIEW_URL) throw new Error('VIEW_URL missing in timeline.conf');
    if(!cfg.EDITOR_URL) console.warn('EDITOR_URL missing; footer link will be disabled.');
    return cfg;
  }catch(e){
    console.error('[Config]', e);
    throw e;
  }
}

/* Build CSV export URL from VIEW_URL */
function csvUrlFromView(viewUrl){
  try{
    const u = new URL(viewUrl);
    const gid = (u.hash.match(/gid=(\d+)/) || [null, "0"])[1];
    return viewUrl.replace(/\/edit.*$/, "/export?format=csv&gid=" + gid);
  }catch(e){
    return viewUrl.replace(/\/edit.*$/, "/export?format=csv");
  }
}

/* ===== Hamburger ===== */
const hamburger = document.getElementById("hamburger");
const menu      = document.getElementById("menu");

function setMenuTabIndices(disabled){
  menu.querySelectorAll('a').forEach(a=>{
    if(disabled) a.setAttribute('tabindex','-1');
    else a.removeAttribute('tabindex');
  });
}

function openMenu(){ menu.classList.add("open"); hamburger.setAttribute("aria-expanded","true"); menu.setAttribute("aria-hidden","false"); setMenuTabIndices(false); }
function closeMenu(){ menu.classList.remove("open"); hamburger.setAttribute("aria-expanded","false"); menu.setAttribute("aria-hidden","true"); setMenuTabIndices(true); }
hamburger.addEventListener("click", e=>{ e.stopPropagation(); menu.classList.contains("open") ? closeMenu() : openMenu(); });
document.addEventListener("click", e=>{ if(!menu.contains(e.target) && !hamburger.contains(e.target)) closeMenu(); });
window.addEventListener("keydown", e=>{ if(e.key==="Escape") closeMenu(); });
setMenuTabIndices(true);

/* ===== CSV ===== */
function parseCSV(text){
  const rows=[]; let field="", row=[], inQ=false;
  for(let i=0;i<text.length;i++){
    const c=text[i];
    if(inQ){
      if(c==='"'){ if(text[i+1]==='"'){ field+='"'; i++; } else inQ=false; }
      else field+=c;
    } else {
      if(c==='"') inQ=true;
      else if(c===','){ row.push(field); field=""; }
      else if(c==='\n'){ row.push(field); rows.push(row); row=[]; field=""; }
      else if(c!=='\r'){ field+=c; }
    }
  }
  row.push(field);
  if(row.length>1 || row[0]!=="") rows.push(row);
  return rows;
}
function kvFromTwoColumn(rows){
  const kv={};
  for(const r of rows){ const k=(r[0]||"").trim(); const v=(r[1]||"").trim(); if(k) kv[k]=v; }
  return kv;
}
function ciGet(kv,label){
  const want=label.toLowerCase();
  for(const k of Object.keys(kv)) if(k.toLowerCase()===want) return kv[k];
  return "";
}
function slugify(s,fallback){
  const base=(s||"").toLowerCase().replace(/&/g," and ").replace(/[^a-z0-9]+/g,"-").replace(/^-+|-+$/g,"");
  return base||fallback;
}

/* ===== Markdown (links + bold/italic + blockquotes + newlines) ===== */
function escapeHTML(s){ return (s||"").replace(/[&<>"']/g, ch => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[ch])); }
function renderMarkdown(text){
  if(!text) return "";
  const linkTokens=[]; let linkIdx=0;
  let tmp = text.replace(/\[([^\]]+)\]\((https?:\/\/[^\s)]+)\)/g,(m,label,url)=>{
    const token=`__MDLINK_${linkIdx++}__`;
    linkTokens.push({token, html:`<a href="${url}" target="_blank" rel="noopener noreferrer">${escapeHTML(label)}</a>`});
    return token;
  });
  tmp = escapeHTML(tmp)
    .replace(/(https?:\/\/[^\s<)]+)([)\s.,;!?]*)/g,(m,url,trail)=>`<a href="${url}" target="_blank" rel="noopener noreferrer">${url}</a>${trail}`)
    .replace(/(^|[\s(])((?:www\.)[^\s<)]+)([)\s.,;!?]*)/g,(m,pre,url,trail)=>`${pre}<a href="https://${url}" target="_blank" rel="noopener noreferrer">${url}</a>${trail}`)
    .replace(/(\*\*\*)([\s\S]+?)\1/g, '<strong><em>$2</em></strong>')
    .replace(/(\*\*)([\s\S]+?)\1/g, '<strong>$2</strong>')
    .replace(/(\*)([\s\S]+?)\1/g, '<em>$2</em>');
  { // blockquotes grouped
    const lines = tmp.split('\n'); const out = []; let buf = [];
    const flush = () => { if (buf.length) { out.push('<blockquote>'+buf.join('<br>')+'</blockquote>'); buf=[]; } };
    for (const raw of lines) {
      const t = raw.replace(/^\s+/, '');
      if (t.startsWith('&gt;')) buf.push(t.replace(/^&gt;\s?/, '')); else { flush(); out.push(raw); }
    }
    flush(); tmp = out.join('\n');
  }
  tmp = tmp.replace(/\n/g,'<br>');
  for(const L of linkTokens) tmp = tmp.replaceAll(L.token, L.html);
  return tmp;
}

function stripHtml(html){
  const div = document.createElement("div");
  div.innerHTML = html;
  return (div.textContent || "").trim();
}

/* ===== Build sections + entries ===== */
function buildSectionsAndEntries(rows){
  const sections=[];
  let cur = null;
  function ensureCur(){ if(!cur){ cur = { title:"", img:"", cap:"", desc:"", id:"", entriesRaw:{img:[], cap:[], desc:[], date:[]} }; sections.push(cur); } }

  for(const r of rows){
    const key = (r[0]||"").trim();
    const val = (r[1]||"").trim();
    if(!key) continue;
    const k = key.toLowerCase();

    if(k === "section heading"){
      cur = { title: val || "Section", img:"", cap:"", desc:"", id: slugify(val||`section-${sections.length+1}`, `section-${sections.length+1}`), entriesRaw:{img:[], cap:[], desc:[], date:[]} };
      sections.push(cur);
    } else if(k === "section image"){ ensureCur(); cur.img = val;
    } else if(k === "section caption"){ ensureCur(); cur.cap = val;
    } else if(k === "section description"){ ensureCur(); cur.desc = val;

    } else if(k === "entry image"){ ensureCur(); cur.entriesRaw.img.push(val);
    } else if(k === "entry caption"){ ensureCur(); cur.entriesRaw.cap.push(val);
    } else if(k === "entry description"){ ensureCur(); cur.entriesRaw.desc.push(val);
    } else if(k === "entry date"){ ensureCur(); cur.entriesRaw.date.push(val); }
  }

  for(const s of sections){
    const n = Math.max(s.entriesRaw.img.length, s.entriesRaw.cap.length, s.entriesRaw.desc.length, s.entriesRaw.date.length);
    const entries=[];
    for(let i=0;i<n;i++){
      entries.push({
        img: s.entriesRaw.img[i] || "",
        cap: s.entriesRaw.cap[i] || "",
        desc: s.entriesRaw.desc[i] || "",
        date: s.entriesRaw.date[i] || "",
        side: (i % 2 === 0) ? "left" : "right"
      });
    }
    s.entries = entries;
  }
  return sections;
}

/* ===== Date helpers ===== */
function parseDateLoose(s){
  if(!s) return null;
  const yOnly = /^\s*(\d{3,4})\s*$/.exec(s);
  if(yOnly) return new Date(Number(yOnly[1]), 0, 1).getTime();
  const d = new Date(s);
  if(!isNaN(d.getTime())) return d.getTime();
  return null;
}
function initialPositions(entries){
  const PAD_TOP = 100, PAD_BOTTOM = 64;
  const baseHeight = Math.max(600, entries.length * 160);
  const times = entries.map(e => parseDateLoose(e.date));
  const valids = times.filter(t => t !== null);
  const minT = valids.length ? Math.min(...valids) : null;
  const maxT = valids.length ? Math.max(...valids) : null;
  const usable = minT !== null && maxT !== null && minT < maxT;

  const Y = entries.map((e,i)=>{
    const range = baseHeight - (PAD_TOP + PAD_BOTTOM);
    if(usable && times[i]!==null){
      const pct = (times[i]-minT)/(maxT-minT);
      return Math.round(PAD_TOP + pct * range);
    } else {
      const pct = entries.length>1 ? (i/(entries.length-1)) : 0.5;
      return Math.round(PAD_TOP + pct * range);
    }
  });
  return {baseHeight, Y};
}

/* ===== Layout (baseline v1.4) ===== */
function layoutTimeline(tl){
  const cards = Array.from(tl.querySelectorAll('.timeline-entry'));
  const labels = Array.from(tl.querySelectorAll('.timeline-label'));
  const labelByIndex = new Map();
  labels.forEach(l => labelByIndex.set(l.dataset.i, l));

  const SAME_GAP = 42;
  const RESERVE_GAP = 32;
  const LABEL_ANCHOR = 12;

  const chronological = cards.slice().sort((a,b)=>
    parseFloat(a.dataset.seedTop||'0') - parseFloat(b.dataset.seedTop||'0')
  );

  const bottom = { left: -Infinity, right: -Infinity };

  for (const el of chronological){
    const side = el.classList.contains('right') ? 'right' : 'left';
    const other = side === 'right' ? 'left' : 'right';
    let top = parseFloat(el.dataset.seedTop||'0');

    top = Math.max(top, bottom[side] + SAME_GAP);
    top = Math.max(top, bottom[other] + SAME_GAP);

    el.style.top = top + 'px';
    const h = el.offsetHeight;
    bottom[side] = top + h;

    const reservedBottom = top + h + RESERVE_GAP;
    if (bottom[other] < reservedBottom) bottom[other] = reservedBottom;

    const label = labelByIndex.get(el.dataset.i);
    if (label){
      label.style.top = (top + LABEL_ANCHOR) + 'px';
      label.classList.toggle('left',  side === 'left');
      label.classList.toggle('right', side === 'right');
    }
  }

  const maxBottom = Math.max(bottom.left, bottom.right);
  tl.style.height = Math.ceil(maxBottom + 90) + 'px';
  rebuildAnchorTargets();
}

/* ===== Renderers ===== */
function renderMenu(sections){
  const ul = document.getElementById("menuList"); ul.innerHTML = "";

  const liStart = document.createElement("li");
  const aStart = document.createElement("a");
  aStart.className = "menu-link current";
  aStart.href = "#top";
  aStart.textContent = "Start of timeline";
  liStart.appendChild(aStart);
  ul.appendChild(liStart);

  sections.forEach((sec, idx) => {
    const li=document.createElement("li");
    const a=document.createElement("a");
    a.className="menu-link";
    a.href="#"+sec.id;
    a.textContent=sec.title || "Section";
    if (idx === sections.length - 1) a.classList.add("branch-last"); else a.classList.add("branch");
    li.appendChild(a); ul.appendChild(li);
  });
  setMenuTabIndices(true);
}

function renderSections(sections){
  const container=document.getElementById("sections"); container.innerHTML="";
  sections.forEach(sec=>{
    const wrapper = document.createElement("section");
    wrapper.className = "section";

    const h2=document.createElement("h2");
    h2.className="section-heading"; h2.id=sec.id || slugify(sec.title, "section");
    h2.textContent=sec.title || "Section";
    wrapper.appendChild(h2);

    const block=document.createElement("div"); block.className="section-block";
    if(sec.img){
      const img=document.createElement("img");
      img.className="section-image"; img.src=sec.img;
      const altText = stripHtml(renderMarkdown((sec.cap || "").trim())) || sec.title;
      img.alt = altText;
      img.tabIndex = 0;
      img.addEventListener('click', ()=>openLightbox(img.src, img.alt));
      img.addEventListener('keydown', e=>{ if(e.key==='Enter' || e.key===' ') openLightbox(img.src, img.alt); });
      img.addEventListener('load', rebuildAnchorTargets);
      block.appendChild(img);
    }
    const cap=document.createElement("div"); cap.className="section-caption";
    cap.innerHTML = renderMarkdown((sec.cap || "").trim()); block.appendChild(cap);
    const desc=document.createElement("div"); desc.className="section-description";
    desc.innerHTML = renderMarkdown((sec.desc || "").trim()); block.appendChild(desc);

    wrapper.appendChild(block);

    if(sec.entries && sec.entries.length){
      const tl = document.createElement("div"); tl.className="timeline";
      const line = document.createElement("div"); line.className="timeline-line"; tl.appendChild(line);

      const pos = initialPositions(sec.entries);

      sec.entries.forEach((e, idx)=>{
        const y = pos.Y[idx];

        const dateText = (e.date||"").trim();
        if (dateText.length > 0){
          const lab = document.createElement("div");
          const side = (e.side || (idx%2?'right':'left'));
          lab.className = "timeline-label " + side;
          lab.textContent = dateText;
          lab.style.top = y + "px";
          lab.dataset.i = String(idx);
          tl.appendChild(lab);
        }

        const wrap = document.createElement("div");
        wrap.className = "timeline-entry " + (e.side || (idx%2?'right':'left'));
        const seed = y - 10;
        wrap.style.top = seed + "px";
        wrap.dataset.i = String(idx);
        wrap.dataset.seedTop = String(seed);
        wrap.id = `${h2.id}-e${idx+1}`;

        const card = document.createElement("div"); card.className="entry-card";

        if(e.img){
          const im = document.createElement("img");
          im.className="entry-image"; im.src=e.img;
          const altText = stripHtml(renderMarkdown((e.cap || "").trim())) || `Entry ${idx+1}`;
          im.alt = altText;
          im.tabIndex = 0;
          im.addEventListener('click', ()=>openLightbox(im.src, im.alt));
          im.addEventListener('keydown', ev=>{ if(ev.key==='Enter' || ev.key===' ') openLightbox(im.src, im.alt); });
          im.addEventListener('load', ()=>layoutTimeline(tl));
          card.appendChild(im);
        }
        const c = document.createElement("div"); c.className="entry-caption";
        c.innerHTML = renderMarkdown((e.cap||"").trim()); card.appendChild(c);

        const d = document.createElement("div"); d.className="entry-description";
        d.innerHTML = renderMarkdown((e.desc||"").trim());
        card.appendChild(d);

        wrap.appendChild(card);
        tl.appendChild(wrap);
      });

      requestAnimationFrame(()=>layoutTimeline(tl));
      window.addEventListener('resize', ()=>layoutTimeline(tl));

      wrapper.appendChild(tl);
    }

    container.appendChild(wrapper);
  });

  rebuildAnchorTargets();
}

/* ===== Lightbox ===== */
const lightbox = document.getElementById('lightbox');
const lightboxImg = document.getElementById('lightboxImg');
const lightboxClose = document.getElementById('lightboxClose');
let lastFocus = null;
function openLightbox(src, alt){
  lastFocus = document.activeElement;
  lightboxImg.src = src; lightboxImg.alt = alt || '';
  lightbox.classList.add('open'); document.body.classList.add('modal-open');
  lightboxClose.focus();
}
function closeLightbox(){
  lightbox.classList.remove('open'); document.body.classList.remove('modal-open');
  lightboxImg.src = ''; if (lastFocus && lastFocus.focus) lastFocus.focus();
}
lightbox.addEventListener('click', (e)=>{ if (e.target.dataset.close !== undefined) closeLightbox(); });
lightboxClose.addEventListener('click', closeLightbox);
window.addEventListener('keydown', (e)=>{ if (e.key === 'Escape' && lightbox.classList.contains('open')) closeLightbox(); });

/* ===== Anchors ===== */
let anchors = [];
function rebuildAnchorTargets(){
  anchors = Array.from(document.querySelectorAll('h2.section-heading, .timeline-entry'));
  anchors.sort((a,b)=> (a.getBoundingClientRect().top + window.scrollY) - (b.getBoundingClientRect().top + window.scrollY));
}

/* ===== Bootstrap with external config ===== */
async function loadFromCSVUrl(url){
  const res = await fetch(url, {mode:"cors", cache:"no-cache"});
  const text = await res.text();
  if (!res.ok || /^\s*</.test(text)) throw new Error("CSV fetch failed or returned HTML.");
  return text;
}
function showFallback(msg){
  const fb = document.getElementById("fallback");
  const note = document.getElementById("fallbackNote");
  note.textContent = msg || "";
  fb.classList.add("visible");
}

(async function main(){
  try{
    // Load config
    const conf = await loadConfig();
    const VIEW_URL = conf.VIEW_URL;
    const CSV_URL  = csvUrlFromView(VIEW_URL);
    const EDITOR_URL = conf.EDITOR_URL || null;

    // Wire footer Editor Login if provided
    const editorLink = document.getElementById('editorLink');
    if(editorLink){
      if (EDITOR_URL){ editorLink.href = EDITOR_URL; }
      else { editorLink.removeAttribute('href'); editorLink.style.opacity = '0.6'; editorLink.style.pointerEvents = 'none'; }
    }

    // Fetch + render
    const csvText = await loadFromCSVUrl(CSV_URL);
    const rows = parseCSV(csvText);
    const kv = kvFromTwoColumn(rows);

    const hero = ciGet(kv,"Hero Image");
    const title = ciGet(kv,"Title") || "Untitled";
    const sub = ciGet(kv,"Sub-Title") || "";

    if(hero) document.getElementById("hero").style.backgroundImage = `url("${hero}")`;
    document.getElementById("title").textContent = title + "!";
    document.getElementById("subtitle").textContent = sub;

    const sections = buildSectionsAndEntries(rows);
    renderMenu(sections);
    renderSections(sections);

    rebuildAnchorTargets();
    window.addEventListener('resize', rebuildAnchorTargets);

  }catch(err){
    console.error("[Boot] Error:", err);
    document.getElementById("title").textContent = "CSV not loaded";
    document.getElementById("subtitle").textContent = "Use the file picker below to load a CSV export.";
    showFallback(err.message || String(err));
  }

  const fileInput = document.getElementById("fileInput");
  if(fileInput){
    fileInput.addEventListener("change", async (e)=>{
      const f = e.target.files && e.target.files[0];
      if(!f) return;
      const txt = await f.text();
      const rows = parseCSV(txt);
      const kv = kvFromTwoColumn(rows);

      const hero = ciGet(kv,"Hero Image");
      const title = ciGet(kv,"Title") || "Untitled";
      const sub = ciGet(kv,"Sub-Title") || "";

      if(hero) document.getElementById("hero").style.backgroundImage = `url("${hero}")`;
      document.getElementById("title").textContent = title;
      document.getElementById("subtitle").textContent = sub;

      const sections = buildSectionsAndEntries(rows);
      renderMenu(sections);
      renderSections(sections);

      rebuildAnchorTargets();
      document.getElementById("fallback").classList.remove("visible");
    });
  }
})();
</script>
</body>
</html> 
